(this.webpackJsonpclient=this.webpackJsonpclient||[]).push([[0],{14:function(e,t,s){},15:function(e,t,s){},17:function(e,t,s){"use strict";s.r(t);var n=s(1),a=s.n(n),r=s(5),i=s.n(r),o=(s(14),s(4)),u=s(6),c=s(7),d=s(2),l=s(9),h=s(8),m=(s(15),s(0)),p=null,g=function(e){Object(l.a)(s,e);var t=Object(h.a)(s);function s(e){var n;return Object(u.a)(this,s),(n=t.call(this,e)).messageToken=null,n.streamToken=null,n.stream=null,n.chats=[],n.users={},n.state={updatedData:!0},p=Object(d.a)(n),n.keyUpLoginModal=n.keyUpLoginModal.bind(Object(d.a)(n)),n.keyUpMessage=n.keyUpMessage.bind(Object(d.a)(n)),n}return Object(c.a)(s,[{key:"update_users",value:function(){this.setState((function(e){var t=e.updatedData;return Object(o.a)({},"updatedData",!t)}))}},{key:"date_format",value:function(e){var t=new Date(1e3*e);return t.toLocaleDateString("en-US")+" "+t.toLocaleTimeString("en-US")}},{key:"output",value:function(e){p.chats.push(e),this.setState((function(e){var t=e.updatedData;return Object(o.a)({},"updatedData",!t)})),this.chat.scrollTop=this.chat.scrollHeight-this.chat.clientHeight}},{key:"chatMessages",value:function(){return this.chats.map((function(e){return Object(m.jsx)("div",{children:"chatItem"})}))}},{key:"handle_connect",value:function(){this.message.disabled=!1,this.message.value="",this.title.classList.remove("disconnected")}},{key:"handle_disconnect",value:function(e){this.message.disabled=!0,this.message.value="Please connect to send messages.",this.title.classList.add("disconnected"),e&&(this.users=new Set,this.update_users())}},{key:"show_login",value:function(){this.url.value=sessionStorage.getItem("url")||"https://chat.cs291.com",this.login_modal.style.display="block"}},{key:"componentDidMount",value:function(){null===this.messageToken?(this.handle_disconnect(!0),this.show_login()):this.start_stream()}},{key:"start_stream",value:function(){var e=this,t=p;this.stream=new EventSource(sessionStorage.getItem("url")+"/stream/"+this.streamToken),this.stream.addEventListener("open",(function(){t.handle_connect()})),this.stream.addEventListener("Disconnect",(function(){e.close(),t.handle_disconnect(!0),t.messageToken=null,t.streamToken=null,t.chat.innerHTML="",t.show_login()}),!1),this.stream.addEventListener("Join",(function(e){var s=JSON.parse(e.data);t.users.add(s.user),t.update_users(),t.output(t.date_format(s.created)+" JOIN: "+s.user)}),!1),this.stream.addEventListener("Message",(function(e){var s=JSON.parse(e.data);t.output(t.date_format(s.created)+" ("+s.user+") "+s.message)}),!1),this.stream.addEventListener("Part",(function(e){var s=JSON.parse(e.data);t.users.delete(s.user),t.update_users(),t.output(t.date_format(s.created)+" PART: "+s.user)}),!1),this.stream.addEventListener("ServerStatus",(function(e){var s=JSON.parse(e.data);t.output(t.date_format(s.created)+" STATUS: "+s.status)}),!1),this.stream.addEventListener("Users",(function(e){var s=JSON.parse(e.data).users;t.users=new Set(s),t.update_users()}),!1),this.stream.addEventListener("error",(function(e){2===e.target.readyState?(t.messageToken=null,t.streamToken=null,t.handle_disconnect(!0),t.show_login()):(t.handle_disconnect(!1),console.log("Disconnected, retrying"))}),!1)}},{key:"login",value:function(){var e=new XMLHttpRequest,t=new FormData;t.append("password",this.password.value),t.append("username",this.username.value),sessionStorage.setItem("url",this.url.value),e.open("POST",sessionStorage.getItem("url")+"/login"),e.onreadystatechange=function(){if(4===this.readyState)if(201===this.status){p.login_modal.style.display="none",p.password.value="",p.username.value="";var e=JSON.parse(this.responseText);p.messageToken=e.message_token,p.streamToken=e.stream_token,p.start_stream()}else 403===this.status?alert("Invalid username or password"):409===this.status?alert(p.username.value+" is already logged in"):alert(this.status+" failure to /login")},e.send(t)}},{key:"keyUpLoginModal",value:function(e){null===this.messageToken&&"Enter"===e.key&&this.login()}},{key:"keyUpMessage",value:function(e){var t=this;if(null!==this.messageToken&&"Enter"===e.key&&(e.preventDefault(),""!==this.message.value)){var s=new FormData;s.append("message",this.message.value);var n=new XMLHttpRequest;n.open("POST",sessionStorage.getItem("url")+"/message"),n.setRequestHeader("Authorization","Bearer "+this.messageToken),n.onreadystatechange=function(e){4===e.target.readyState&&403!==e.target.status&&null!=t.messageToken&&(t.messageToken=e.target.getResponseHeader("token"))},n.send(s),this.message.value=""}}},{key:"render",value:function(){var e=this;return Object(m.jsxs)("div",{children:[Object(m.jsx)("title",{children:"Budget-Cut Whatsapp"}),Object(m.jsxs)("section",{id:"container",children:[Object(m.jsx)("h1",{id:"title",ref:function(t){return e.title=t},class:"disconnected",children:"Budget-Cut Whatsapp"}),Object(m.jsxs)("div",{id:"window",children:[Object(m.jsx)("div",{id:"chat",ref:function(t){return e.chat=t},children:Object(m.jsx)("ul",{children:this.chats.map((function(e){return Object(m.jsx)("li",{children:e})}))})}),Object(m.jsxs)("div",{id:"user_window",children:[Object(m.jsx)("h2",{children:"Online"}),Object(m.jsx)("ul",{id:"users",ref:function(t){return e.user_list=t},children:Array.from(this.users).sort().map((function(e){return Object(m.jsx)("li",{children:e})}))})]})]}),Object(m.jsx)("input",{id:"message",onKeyUp:this.keyUpMessage,ref:function(t){return e.message=t},type:"text"})]}),Object(m.jsx)("div",{id:"login-modal",onKeyUp:this.keyUpLoginModal,ref:function(t){return e.login_modal=t},children:Object(m.jsxs)("div",{class:"content",children:[Object(m.jsx)("h2",{children:"Login"}),Object(m.jsx)("div",{children:Object(m.jsxs)("label",{children:["Chat URL ",Object(m.jsx)("br",{}),Object(m.jsx)("input",{id:"url",ref:function(t){return e.url=t},type:"text"})]})}),Object(m.jsx)("div",{children:Object(m.jsxs)("label",{children:["Username ",Object(m.jsx)("br",{}),Object(m.jsx)("input",{id:"username",ref:function(t){return e.username=t},type:"text"})]})}),Object(m.jsx)("div",{children:Object(m.jsxs)("label",{children:["Password ",Object(m.jsx)("br",{}),Object(m.jsx)("input",{id:"password",ref:function(t){return e.password=t},type:"password"})]})})]})})]})}}]),s}(n.Component);i.a.render(Object(m.jsx)(a.a.StrictMode,{children:Object(m.jsx)(g,{})}),document.getElementById("root"))}},[[17,1,2]]]);
//# sourceMappingURL=main.605738f0.chunk.js.map